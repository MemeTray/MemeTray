name: Update sections.json

on:
  # Schedule: run daily at 2 AM UTC
  schedule:
    - cron: '0 2 * * *'

  # Manual trigger
  workflow_dispatch:

jobs:
  update-sections:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Update sections.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create a Node.js script to update sections.json
          cat > update-sections.js << 'EOF'
          const fs = require('fs');
          const https = require('https');

          // GitHub API request helper
          function githubApi(path) {
            return new Promise((resolve, reject) => {
              const options = {
                hostname: 'api.github.com',
                path: path,
                method: 'GET',
                headers: {
                  'User-Agent': 'MemeTray-Bot',
                  'Authorization': `token ${process.env.GITHUB_TOKEN}`,
                  'Accept': 'application/vnd.github.v3+json'
                }
              };

              https.get(options, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => {
                  if (res.statusCode === 200) {
                    resolve(JSON.parse(data));
                  } else {
                    reject(new Error(`GitHub API error: ${res.statusCode} ${data}`));
                  }
                });
              }).on('error', reject);
            });
          }

          // Fetch every repository in the organization
          async function getOrgRepos() {
            console.log('Fetching MemeTray organization repositories...');
            const repos = await githubApi('/orgs/MemeTray/repos?per_page=100');

            // Keep repositories whose names start with 'gifs-'
            const gifsRepos = repos
              .filter(repo => repo.name.startsWith('gifs-'))
              .map(repo => ({
                name: repo.name,
                fullName: repo.full_name,
                section: repo.name.replace('gifs-', ''),
                updatedAt: repo.updated_at,
                defaultBranch: repo.default_branch || 'main'
              }));

            console.log(`Found ${gifsRepos.length} gifs repositories:`, gifsRepos.map(r => r.name).join(', '));
            return gifsRepos;
          }

          // Determine the highest GIF index in the repository
          async function countGifs(repo) {
            try {
              console.log(`Counting GIFs in ${repo.name}...`);

              // Fetch the repository file tree
              const tree = await githubApi(`/repos/${repo.fullName}/git/trees/${repo.defaultBranch}?recursive=1`);

              // Filter out .gif files
              const gifFiles = tree.tree.filter(item =>
                item.type === 'blob' && item.path.endsWith('.gif')
              );

              if (gifFiles.length === 0) {
                console.log(`  → No GIF files found`);
                return 0;
              }

              // Extract numeric prefixes that match 0001_name.gif
              const numbers = gifFiles
                .map(file => {
                  const match = file.path.match(/(\d{4})_.*\.gif$/);
                  return match ? parseInt(match[1], 10) : 0;
                })
                .filter(num => num > 0);

              if (numbers.length === 0) {
                console.log(`  → Found ${gifFiles.length} GIF files but no valid numbered files`);
                return gifFiles.length;
              }

              // Find the maximum index
              const maxNumber = Math.max(...numbers);
              console.log(`  → Found ${gifFiles.length} GIF files, max number: ${maxNumber}`);
              return maxNumber;
            } catch (error) {
              console.error(`  ✗ Error counting GIFs in ${repo.name}:`, error.message);
              return 0;
            }
          }

          // Main function
          async function main() {
            try {
              // Fetch all 'gifs-' repositories
              const repos = await getOrgRepos();

              if (repos.length === 0) {
                console.log('No gifs repositories found!');
                return;
              }

              // Build the sections object
              const sections = {};

              for (const repo of repos) {
                const count = await countGifs(repo);
                const section = repo.section;

                sections[section] = {
                  count: count,
                  title: section,
                  repository: `https://github.com/${repo.fullName}`,
                  repositoryName: repo.name,
                  cdnBase: `https://cdn.jsdelivr.net/gh/${repo.fullName}@${repo.defaultBranch}/${section}/`,
                  updated: new Date().toISOString()
                };
              }

              // Generate sections.json
              const output = {
                version: "1.0",
                generated: new Date().toISOString(),
                sections: sections
              };

              // Write the file to both the repository root and docs directory
              fs.writeFileSync('sections.json', JSON.stringify(output, null, 2) + '\n');
              fs.writeFileSync('docs/sections.json', JSON.stringify(output, null, 2) + '\n');
              console.log('\n✓ sections.json updated successfully!');

              // Print summary statistics
              console.log('\nStatistics:');
              Object.entries(sections).forEach(([key, data]) => {
                console.log(`  ${key}: ${data.count} GIFs`);
              });

            } catch (error) {
              console.error('Error:', error);
              process.exit(1);
            }
          }

          main();
          EOF

          # Run the script
          node update-sections.js

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if anything changed
          if git diff --quiet sections.json docs/sections.json; then
            echo "No changes to sections.json"
            exit 0
          fi

          # Collect statistics for the commit message
          STATS=$(node -e "
            const data = require('./sections.json');
            const sections = data.sections;
            const summary = Object.entries(sections)
              .map(([key, val]) => \`\${key}:\${val.count}\`)
              .join(', ');
            console.log(summary);
          ")

          git add sections.json docs/sections.json
          git commit -m "chore: update sections.json ($STATS)"
          git push

          echo "✓ sections.json committed and pushed"
